<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WT32-ETH01 網路配置系統</title>
    <style>
      :root {
        --primary: #4361ee;
        --secondary: #3a0ca3;
        --success: #4cc9f0;
        --warning: #f72585;
        --light: #f8f9fa;
        --dark: #343a40;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: var(--primary);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header .subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .content {
        display: grid;
        grid-template-columns: 300px 1fr;
        min-height: 600px;
      }

      .sidebar {
        background: var(--light);
        padding: 30px 20px;
        border-right: 1px solid #eaeaea;
      }

      .nav-item {
        padding: 15px 20px;
        margin: 5px 0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
      }

      .nav-item:hover {
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .nav-item.active {
        background: white;
        color: var(--primary);
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
      }

      .nav-icon {
        margin-right: 10px;
        font-size: 1.2rem;
      }

      .main-content {
        padding: 30px;
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.5s;
      }

      .tab-content.active {
        display: block;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        border: 1px solid #eaeaea;
      }

      .card-title {
        font-size: 1.3rem;
        color: var(--dark);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--light);
        display: flex;
        align-items: center;
      }

      .card-title i {
        margin-right: 10px;
        color: var(--primary);
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .status-card {
        padding: 20px;
        border-radius: 10px;
        color: white;
        position: relative;
        overflow: hidden;
      }

      .status-card::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.1);
        z-index: 1;
      }

      .status-card > * {
        position: relative;
        z-index: 2;
      }

      .status-card.wifi {
        background: linear-gradient(135deg, var(--success), #3a9db9);
      }

      .status-card.eth {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
      }

      .status-card.ap {
        background: linear-gradient(135deg, var(--warning), #c2185b);
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }

      .status-online {
        background: #4ade80;
      }

      .status-offline {
        background: #f87171;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #444;
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
      }

      .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
      }

      .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn i {
        margin-right: 8px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--secondary);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
      }

      .btn-success {
        background: var(--success);
        color: white;
      }

      .btn-success:hover {
        background: #3a9db9;
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .wifi-list {
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin: 15px 0;
      }

      .wifi-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: all 0.3s;
      }

      .wifi-item:hover {
        background: #f8f9ff;
      }

      .wifi-item.selected {
        background: rgba(67, 97, 238, 0.1);
        border-left: 4px solid var(--primary);
      }

      .signal-bars {
        display: flex;
        align-items: flex-end;
        height: 20px;
        gap: 2px;
      }

      .signal-bar {
        width: 5px;
        background: #ddd;
        border-radius: 2px;
      }

      .signal-bar.active {
        background: #4ade80;
      }

      .mode-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }

      .mode-option {
        padding: 20px;
        text-align: center;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .mode-option:hover {
        border-color: var(--primary);
        background: #f8f9ff;
      }

      .mode-option.active {
        border-color: var(--primary);
        background: rgba(67, 97, 238, 0.1);
        color: var(--primary);
        font-weight: bold;
      }

      .mode-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        display: block;
      }

      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 15px 25px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        z-index: 1000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast-success {
        border-left: 4px solid #28a745;
      }

      .toast-error {
        border-left: 4px solid #dc3545;
      }

      .connection-card {
        background: linear-gradient(135deg, #e0f7fa, #bbdefb);
        border: 1px solid #4fc3f7;
        border-left: 4px solid #0288d1;
      }

      .connection-info {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 15px;
        align-items: center;
      }

      .connection-icon {
        background: #0288d1;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .connection-details {
        display: flex;
        flex-direction: column;
      }

      .connection-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 5px;
      }

      .connection-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #0288d1;
      }

      .copy-btn {
        background: #0288d1;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-top: 5px;
        transition: background 0.3s;
      }

      .copy-btn:hover {
        background: #0277bd;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }
      }

      @media (max-width: 768px) {
        .content {
          grid-template-columns: 1fr;
        }

        .sidebar {
          display: flex;
          overflow-x: auto;
          padding: 15px;
        }

        .nav-item {
          white-space: nowrap;
          margin: 0 10px;
        }

        .connection-info {
          grid-template-columns: 1fr;
          text-align: center;
        }

        .connection-icon {
          margin: 0 auto;
        }
      }

      /* ============ 新增的彈跳視窗樣式 ============ */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        transform: translateY(-50px);
        opacity: 0;
        transition: all 0.4s;
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
        opacity: 1;
      }

      .modal-header {
        background: linear-gradient(135deg, #4cc9f0, #4361ee);
        color: white;
        padding: 25px 30px;
        border-radius: 20px 20px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px;
        transition: transform 0.3s;
      }

      .modal-close:hover {
        transform: scale(1.2);
      }

      .modal-body {
        padding: 30px;
      }

      .modal-content {
        text-align: center;
      }

      .modal-icon {
        font-size: 4rem;
        color: #4cc9f0;
        margin-bottom: 20px;
        animation: bounce 1s;
      }

      .modal-message {
        font-size: 1.1rem;
        line-height: 1.6;
        color: #444;
        margin-bottom: 25px;
        white-space: pre-line;
      }

      .ip-display {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 2px dashed #4361ee;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
        position: relative;
      }

      .ip-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 8px;
      }

      .ip-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #4361ee;
        font-family: "Courier New", monospace;
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        word-break: break-all;
      }

      .ip-copy-btn {
        background: #4361ee;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 0.9rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        margin-top: 10px;
      }

      .ip-copy-btn:hover {
        background: #3a0ca3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
      }

      .ip-copy-btn.copied {
        background: #28a745;
      }

      .modal-footer {
        padding: 20px 30px;
        background: #f8f9fa;
        border-radius: 0 0 20px 20px;
        display: flex;
        justify-content: center;
        gap: 15px;
      }

      .modal-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        min-width: 120px;
      }

      .modal-btn-primary {
        background: #4361ee;
        color: white;
      }

      .modal-btn-primary:hover {
        background: #3a0ca3;
        transform: translateY(-2px);
      }

      .modal-btn-secondary {
        background: #6c757d;
        color: white;
      }

      .modal-btn-secondary:hover {
        background: #545b62;
        transform: translateY(-2px);
      }

      .network-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .info-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        text-align: left;
      }

      .info-label {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 5px;
      }

      .info-value {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }

        50% {
          transform: translateY(-10px);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.05);
        }

        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      /* ============ 響應式調整 ============ */
      @media (max-width: 768px) {
        .modal {
          width: 95%;
          margin: 10px;
        }

        .modal-header h3 {
          font-size: 1.3rem;
        }

        .ip-value {
          font-size: 1.4rem;
        }

        .modal-footer {
          flex-direction: column;
        }

        .modal-btn {
          width: 100%;
        }

        .connection-info {
          grid-template-columns: 1fr;
          text-align: center;
        }

        .connection-icon {
          margin: 0 auto;
        }
      }

      /* ============ 新的連接狀態卡片樣式 ============ */
      .connection-card {
        background: linear-gradient(135deg, #e0f7fa, #bbdefb);
        border: 1px solid #4fc3f7;
        border-left: 4px solid #0288d1;
      }

      .connection-info {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 15px;
        align-items: center;
      }

      .connection-icon {
        background: #0288d1;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .connection-details {
        display: flex;
        flex-direction: column;
      }

      .connection-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 5px;
      }

      .connection-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #0288d1;
      }

      .copy-btn {
        background: #0288d1;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-top: 5px;
        transition: background 0.3s;
      }

      .copy-btn:hover {
        background: #0277bd;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>WT32-ETH01</h1>
        <div class="subtitle">雙網路配置系統 - WiFi + 乙太網路</div>
      </div>

      <div class="content">
        <div class="sidebar">
          <div class="nav-item active" data-tab="dashboard">
            <i class="nav-icon fas fa-tachometer-alt"></i>
            儀表板
          </div>
          <div class="nav-item" data-tab="wifi">
            <i class="nav-icon fas fa-wifi"></i>
            WiFi 設定
          </div>
          <div class="nav-item" data-tab="ethernet">
            <i class="nav-icon fas fa-network-wired"></i>
            乙太網路
          </div>
          <div class="nav-item" data-tab="mode">
            <i class="nav-icon fas fa-cog"></i>
            網路模式
          </div>
          <div class="nav-item" data-tab="system">
            <i class="nav-icon fas fa-sliders-h"></i>
            系統設定
          </div>
        </div>

        <div class="main-content">
          <!-- 儀表板 -->
          <div id="dashboard" class="tab-content active">
            <div class="status-grid">
              <div class="status-card wifi">
                <h3>
                  <span class="status-indicator" id="wifiStatus"></span> WiFi
                  狀態
                </h3>
                <p id="wifiInfo">載入中...</p>
              </div>
              <div class="status-card eth">
                <h3>
                  <span class="status-indicator" id="ethStatus"></span>
                  乙太網路狀態
                </h3>
                <p id="ethInfo">載入中...</p>
              </div>
              <div class="status-card ap">
                <h3>目前模式</h3>
                <p id="currentMode">載入中...</p>
              </div>
            </div>

            <div class="card" style="margin-top: 20px">
              <h3 class="card-title">
                <i class="fas fa-microchip"></i> 系統線程狀態
              </h3>
              <div class="form-row">
                <div class="form-group">
                  <label>WiFi 線程</label>
                  <div
                    class="status-indicator status-online"
                    style="display: inline-block; margin-right: 10px"
                  ></div>
                  <span id="wifiThreadStatus">運行中</span>
                </div>
                <div class="form-group">
                  <label>乙太網路線程</label>
                  <div
                    class="status-indicator status-online"
                    style="display: inline-block; margin-right: 10px"
                  ></div>
                  <span id="ethThreadStatus">運行中</span>
                </div>
              </div>
            </div>

            <div class="card">
              <h3 class="card-title"><i class="fas fa-bolt"></i> 快速操作</h3>
              <div class="form-row">
                <button class="btn btn-primary" onclick="switchTab('wifi')">
                  <i class="fas fa-wifi"></i> 設定 WiFi
                </button>
                <button class="btn btn-success" onclick="switchToWiFiAndScan()">
                  <i class="fas fa-search"></i> 掃描 WiFi
                </button>
                <button class="btn btn-primary" onclick="switchTab('mode')">
                  <i class="fas fa-cog"></i> 切換模式
                </button>
                <button class="btn btn-primary" onclick="rebootDevice()">
                  <i class="fas fa-redo"></i> 重新啟動
                </button>
              </div>
            </div>

            <div class="card">
              <h3 class="card-title">
                <i class="fas fa-info-circle"></i> 系統資訊
              </h3>
              <p id="systemInfo">載入系統資訊...</p>
            </div>
          </div>

          <!-- WiFi設定 -->
          <div id="wifi" class="tab-content">
            <div class="card">
              <h3 class="card-title"><i class="fas fa-wifi"></i> WiFi 設定</h3>

              <div class="form-group">
                <button
                  class="btn btn-success"
                  onclick="scanWifi()"
                  id="scanBtn"
                >
                  <i class="fas fa-search"></i> 掃描 WiFi 網路
                </button>
                <span
                  id="scanStatus"
                  style="margin-left: 15px; color: #666; font-size: 0.9rem"
                ></span>
              </div>

              <div id="wifiList" class="wifi-list">
                <div style="padding: 40px; text-align: center; color: #666">
                  <i
                    class="fas fa-wifi"
                    style="font-size: 2rem; display: block; margin-bottom: 10px"
                  ></i>
                  點擊上方按鈕掃描 WiFi 網路
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="wifiSsid">WiFi 名稱 (SSID)</label>
                  <input
                    type="text"
                    id="wifiSsid"
                    class="form-control"
                    placeholder="輸入 WiFi 名稱"
                  />
                </div>
                <div class="form-group">
                  <label for="wifiPassword">密碼</label>
                  <input
                    type="password"
                    id="wifiPassword"
                    class="form-control"
                    placeholder="輸入 WiFi 密碼"
                  />
                </div>
              </div>

              <button
                class="btn btn-primary"
                onclick="connectWifi()"
                id="connectBtn"
              >
                <i class="fas fa-plug"></i> 連接到 WiFi
              </button>
            </div>
          </div>

          <!-- 乙太網路設定 -->
          <div id="ethernet" class="tab-content">
            <div class="card">
              <h3 class="card-title">
                <i class="fas fa-network-wired"></i> 乙太網路設定
              </h3>

              <div class="form-group">
                <label
                  style="display: flex; align-items: center; cursor: pointer"
                >
                  <input
                    type="checkbox"
                    id="ethDhcp"
                    style="margin-right: 10px"
                    checked
                  />
                  自動取得 IP (DHCP)
                </label>
              </div>

              <div id="staticConfig" style="display: none">
                <div class="form-row">
                  <div class="form-group">
                    <label for="ethIp">IP 位址</label>
                    <input
                      type="text"
                      id="ethIp"
                      class="form-control"
                      placeholder="192.168.1.100"
                    />
                  </div>
                  <div class="form-group">
                    <label for="ethSubnet">子網路遮罩</label>
                    <input
                      type="text"
                      id="ethSubnet"
                      class="form-control"
                      placeholder="255.255.255.0"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="ethGateway">閘道器</label>
                  <input
                    type="text"
                    id="ethGateway"
                    class="form-control"
                    placeholder="192.168.1.1"
                  />
                </div>

                <!-- 新增 DNS 設定 -->
                <div class="form-row">
                  <div class="form-group">
                    <label for="ethDns1">主要 DNS</label>
                    <input
                      type="text"
                      id="ethDns1"
                      class="form-control"
                      placeholder="8.8.8.8"
                    />
                  </div>
                  <div class="form-group">
                    <label for="ethDns2">次要 DNS</label>
                    <input
                      type="text"
                      id="ethDns2"
                      class="form-control"
                      placeholder="8.8.4.4"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <small style="color: #666">
                    <i class="fas fa-info-circle"></i>
                    建議 DNS：8.8.8.8 (Google), 1.1.1.1 (Cloudflare), 168.95.1.1
                    (中華電信)
                  </small>
                </div>
              </div>

              <button class="btn btn-primary" onclick="saveEthConfig()">
                <i class="fas fa-save"></i> 儲存設定
              </button>
            </div>
          </div>

          <!-- 網路模式 -->
          <div id="mode" class="tab-content">
            <div class="card">
              <h3 class="card-title">
                <i class="fas fa-cog"></i> 選擇網路模式
              </h3>

              <div class="mode-selector">
                <div class="mode-option" data-mode="0" onclick="selectMode(0)">
                  <i class="mode-icon fas fa-broadcast-tower"></i>
                  <div>AP 模式</div>
                  <small>初始設定模式</small>
                </div>
                <div class="mode-option" data-mode="1" onclick="selectMode(1)">
                  <i class="mode-icon fas fa-wifi"></i>
                  <div>WiFi 模式</div>
                  <small>僅使用 WiFi</small>
                </div>
                <div class="mode-option" data-mode="2" onclick="selectMode(2)">
                  <i class="mode-icon fas fa-network-wired"></i>
                  <div>乙太網路模式</div>
                  <small>僅使用有線網路</small>
                </div>
                <div class="mode-option" data-mode="3" onclick="selectMode(3)">
                  <i class="mode-icon fas fa-sitemap"></i>
                  <div>雙網路模式</div>
                  <small>同時使用 WiFi + 有線</small>
                </div>
              </div>

              <div class="form-group">
                <button class="btn btn-primary" onclick="saveNetworkMode()">
                  <i class="fas fa-check"></i> 套用模式
                </button>
                <span style="margin-left: 15px; color: #666; font-size: 0.9rem">
                  選擇後需要重新啟動生效
                </span>
              </div>
            </div>
          </div>

          <!-- 系統設定 -->
          <div id="system" class="tab-content">
            <div class="card">
              <h3 class="card-title">
                <i class="fas fa-sliders-h"></i> 系統設定
              </h3>

              <div class="form-group">
                <button class="btn btn-success" onclick="loadConfig()">
                  <i class="fas fa-sync-alt"></i> 載入設定
                </button>
                <button
                  class="btn btn-primary"
                  onclick="saveAllConfig()"
                  style="margin-left: 10px"
                >
                  <i class="fas fa-save"></i> 儲存所有設定
                </button>
              </div>

              <div class="form-group">
                <button class="btn btn-primary" onclick="rebootDevice()">
                  <i class="fas fa-redo"></i> 重新啟動系統
                </button>
                <button
                  class="btn"
                  onclick="resetConfig()"
                  style="margin-left: 10px; background: #f8f9fa; color: #666"
                >
                  <i class="fas fa-undo"></i> 恢復預設值
                </button>
              </div>

              <!-- ============ 新增的 OTA 遠端燒錄區塊 ============ -->
              <div
                class="card"
                style="
                  margin-top: 30px;
                  border: 2px solid #4361ee;
                  background: linear-gradient(135deg, #f8f9ff, #e8eaff);
                "
              >
                <h3 class="card-title" style="color: #4361ee">
                  <i class="fas fa-microchip"></i> OTA 遠端燒錄
                </h3>

                <div class="form-group">
                  <p style="color: #666; margin-bottom: 15px">
                    <i class="fas fa-info-circle"></i>
                    允許通過網路更新韌體，無需連接 USB 線纜。
                  </p>
                </div>

                <div id="otaStatus" style="margin-bottom: 20px">
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      margin-bottom: 10px;
                    "
                  >
                    <span
                      id="otaIndicator"
                      class="status-indicator status-offline"
                      style="margin-right: 10px"
                    ></span>
                    <span id="otaStatusText">OTA 服務未啟動</span>
                  </div>
                  <div id="otaInfo" style="color: #666; font-size: 0.9rem">
                    啟動後可通過網頁上傳或 Arduino IDE 進行更新
                  </div>
                </div>

                <div class="form-row">
                  <button
                    class="btn btn-primary"
                    onclick="startOTA()"
                    id="otaStartBtn"
                  >
                    <i class="fas fa-play"></i> 啟動 OTA 模式
                  </button>
                  <button
                    class="btn btn-success"
                    onclick="checkOTAStatus()"
                    id="otaCheckBtn"
                    style="margin-left: 10px"
                  >
                    <i class="fas fa-sync-alt"></i> 檢查狀態
                  </button>
                </div>

                <!-- 網頁上傳區域 -->
                <div
                  id="otaUploadArea"
                  style="
                    display: none;
                    margin-top: 25px;
                    padding-top: 25px;
                    border-top: 1px solid #e0e0e0;
                  "
                >
                  <h4 style="color: #4361ee; margin-bottom: 15px">
                    <i class="fas fa-upload"></i> 網頁上傳韌體
                  </h4>

                  <div class="form-group">
                    <label for="otaFile">選擇韌體檔案 (.bin)</label>
                    <input
                      type="file"
                      id="otaFile"
                      accept=".bin"
                      class="form-control"
                      style="padding: 10px; border: 2px dashed #4361ee"
                    />
                    <small style="color: #666; display: block; margin-top: 5px">
                      請選擇編譯好的 .bin 檔案
                    </small>
                  </div>

                  <div class="form-group">
                    <div
                      id="uploadProgress"
                      style="margin-top: 15px; display: none"
                    >
                      <div
                        style="
                          display: flex;
                          justify-content: space-between;
                          margin-bottom: 5px;
                        "
                      >
                        <span>上傳進度</span>
                        <span id="uploadPercent">0%</span>
                      </div>
                      <div
                        style="
                          background: #e0e0e0;
                          border-radius: 10px;
                          height: 10px;
                          overflow: hidden;
                        "
                      >
                        <div
                          id="uploadBar"
                          style="
                            background: linear-gradient(
                              90deg,
                              #4361ee,
                              #4cc9f0
                            );
                            height: 100%;
                            width: 0%;
                            transition: width 0.3s;
                          "
                        ></div>
                      </div>
                      <div
                        id="uploadDetails"
                        style="font-size: 0.8rem; color: #666; margin-top: 5px"
                      >
                        0 KB / 0 KB
                      </div>
                    </div>
                  </div>

                  <div class="form-row">
                    <button
                      class="btn btn-success"
                      onclick="uploadFirmware()"
                      id="uploadBtn"
                      disabled
                    >
                      <i class="fas fa-upload"></i> 開始上傳
                    </button>
                    <button
                      class="btn"
                      onclick="cancelUpload()"
                      id="cancelBtn"
                      style="display: none; background: #f8f9fa; color: #666"
                    >
                      <i class="fas fa-times"></i> 取消上傳
                    </button>
                  </div>

                  <!-- Arduino IDE 更新指引 -->
                  <div
                    style="
                      margin-top: 25px;
                      padding: 15px;
                      background: #e8f4fd;
                      border-radius: 10px;
                      border-left: 4px solid #4361ee;
                    "
                  >
                    <h5 style="color: #4361ee; margin-bottom: 10px">
                      <i class="fas fa-laptop-code"></i> Arduino IDE 更新
                    </h5>
                    <p
                      style="
                        color: #666;
                        font-size: 0.9rem;
                        margin-bottom: 10px;
                      "
                    >
                      1. 在 Arduino IDE 中安裝 "WiFi101" 或 "WiFiNINA" 庫<br />
                      2. 工具 → 端口 → 網路端口<br />
                      3. 選擇 <code id="otaHostname">wt32-eth01.local:3232</code
                      ><br />
                      4. 點擊上傳按鈕進行 OTA 更新
                    </p>
                    <button
                      class="copy-btn"
                      onclick="copyHostname()"
                      style="margin-top: 5px"
                    >
                      <i class="fas fa-copy"></i> 複製主機名
                    </button>
                  </div>
                </div>
              </div>
              <!-- ============ OTA 區域結束 ============ -->
            </div>
          </div>
        </div>

        <!-- ============ 新增 OTA 成功彈跳視窗 ============ -->
        <div id="otaSuccessModal" class="modal-overlay">
          <div class="modal" style="max-width: 600px">
            <div
              class="modal-header"
              style="background: linear-gradient(135deg, #28a745, #20c997)"
            >
              <h3>
                <i class="fas fa-check-circle"></i>
                OTA 更新成功
              </h3>
              <button class="modal-close" onclick="closeOtaModal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="modal-body">
              <div class="modal-content">
                <div class="modal-icon">
                  <i class="fas fa-rocket" style="color: #28a745"></i>
                </div>
                <div class="modal-message" id="otaModalMessage">
                  韌體更新成功！系統將自動重新啟動。
                </div>

                <div class="ip-display" style="margin-top: 20px">
                  <div class="ip-label">更新資訊</div>
                  <div
                    class="info-item"
                    style="background: white; margin: 10px 0"
                  >
                    <div class="info-label">檔案名稱</div>
                    <div class="info-value" id="otaFileName">未知</div>
                  </div>
                  <div
                    class="info-item"
                    style="background: white; margin: 10px 0"
                  >
                    <div class="info-label">檔案大小</div>
                    <div class="info-value" id="otaFileSize">0 KB</div>
                  </div>
                  <div
                    class="info-item"
                    style="background: white; margin: 10px 0"
                  >
                    <div class="info-label">更新時間</div>
                    <div class="info-value" id="otaUpdateTime">剛剛</div>
                  </div>
                </div>

                <div
                  style="
                    margin: 20px 0;
                    padding: 15px;
                    background: #e8f4fd;
                    border-radius: 10px;
                  "
                >
                  <p
                    style="color: #666; font-size: 0.9rem; margin-bottom: 10px"
                  >
                    <i
                      class="fas fa-exclamation-triangle"
                      style="color: #ffc107"
                    ></i>
                    系統將在 <span id="otaCountdown">30</span> 秒後自動重新啟動
                  </p>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                class="modal-btn modal-btn-secondary"
                onclick="closeOtaModal()"
              >
                <i class="fas fa-times"></i>
                稍後重啟
              </button>
              <button
                class="modal-btn modal-btn-primary"
                onclick="rebootDevice()"
              >
                <i class="fas fa-redo"></i>
                立即重啟
              </button>
            </div>
          </div>
        </div>

        <!-- 網路連線彈跳視窗 -->
        <div id="connectionModal" class="modal-overlay">
          <div class="modal">
            <div class="modal-header">
              <h3>
                <i class="fas fa-wifi"></i>
                連接成功
              </h3>
              <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="modal-body">
              <div class="modal-content">
                <div class="modal-icon">
                  <i class="fas fa-check-circle pulse"></i>
                </div>
                <div class="modal-message" id="modalMessage">
                  連接成功訊息載入中...
                </div>

                <div class="ip-display">
                  <div class="ip-label">已取得IP位址</div>
                  <div class="ip-value" id="modalIP">192.168.1.100</div>
                  <button class="ip-copy-btn" onclick="copyIP()">
                    <i class="fas fa-copy"></i>
                    複製IP地址
                  </button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                class="modal-btn modal-btn-secondary"
                onclick="closeModal()"
              >
                <i class="fas fa-times"></i>
                關閉
              </button>
              <button
                class="modal-btn modal-btn-primary"
                onclick="openDeviceWeb()"
              >
                <i class="fas fa-external-link-alt"></i>
                訪問設備
              </button>
            </div>
          </div>
        </div>

        <!-- Toast訊息 -->
        <div id="toast" class="toast">
          <div class="toast-icon"></div>
          <div class="toast-message"></div>
        </div>
      </div>
    </div>

    <script>
      // 全局變數
      let selectedWifi = null;
      let selectedMode = 0;
      let currentConfig = {};
      let isScanning = false;
      let currentWiFiIP = "";
      let currentWiFiSSID = "";
      let currentConnectionData = {};
      let otaUploading = false;
      let currentUploadFile = null;
      let otaStatusInterval = null;
      let otaCountdownTimer = null;
      let otaCountdownValue = 30;

      // 頁面加載
      document.addEventListener("DOMContentLoaded", function () {
        // 設置導航點擊
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", function () {
            document
              .querySelectorAll(".nav-item")
              .forEach((i) => i.classList.remove("active"));
            this.classList.add("active");
            const tab = this.getAttribute("data-tab");
            switchTab(tab);
          });
        });

        // 設置檔案選擇監聽
        document
          .getElementById("otaFile")
          .addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              currentUploadFile = file;
              document.getElementById("uploadBtn").disabled = false;

              // 顯示檔案資訊
              showToast(
                `已選擇檔案: ${file.name} (${formatFileSize(file.size)})`,
                "success",
              );
            } else {
              currentUploadFile = null;
              document.getElementById("uploadBtn").disabled = true;
            }
          });

        // 設置DHCP切換
        document
          .getElementById("ethDhcp")
          .addEventListener("change", function () {
            document.getElementById("staticConfig").style.display = this.checked
              ? "none"
              : "block";
          });

        // 加載狀態
        updateNetworkStatus();
        loadConfig();

        // 定時更新狀態
        setInterval(updateNetworkStatus, 5000);

        // 初始檢查 OTA 狀態
        checkOTAStatus();
      });

      // 新增 OTA 相關函數
      function startOTA() {
        const btn = document.getElementById("otaStartBtn");
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 啟動中...';

        fetch("/api/ota/start", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showToast("OTA 模式已啟動", "success");

              // 更新狀態
              document.getElementById("otaIndicator").className =
                "status-indicator status-online";
              document.getElementById("otaStatusText").textContent =
                "OTA 服務運行中";
              document.getElementById("otaInfo").innerHTML = `
        <strong>端口:</strong> 3232<br>
        <strong>主機名:</strong> wt32-eth01.local<br>
        <strong>密碼:</strong> admin123
      `;

              // 顯示上傳區域
              document.getElementById("otaUploadArea").style.display = "block";
              document.getElementById("otaHostname").textContent =
                "wt32-eth01.local:3232";

              // 開始定期檢查狀態
              if (otaStatusInterval) clearInterval(otaStatusInterval);
              otaStatusInterval = setInterval(checkOTAStatus, 5000);

              // 提示重要資訊
              setTimeout(() => {
                showToast("警告: OTA 更新期間請勿斷電！", "error");
              }, 1000);
            } else {
              showToast(data.message || "啟動失敗", "error");
            }
          })
          .catch((error) => {
            console.error("啟動 OTA 失敗:", error);
            showToast("啟動失敗", "error");
          })
          .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
          });
      }

      function checkOTAStatus() {
        fetch("/api/ota/status")
          .then((response) => response.json())
          .then((data) => {
            if (data.ota_started) {
              document.getElementById("otaIndicator").className =
                "status-indicator status-online";
              document.getElementById("otaStatusText").textContent =
                "OTA 服務運行中";
              document.getElementById("otaUploadArea").style.display = "block";
            } else {
              document.getElementById("otaIndicator").className =
                "status-indicator status-offline";
              document.getElementById("otaStatusText").textContent =
                "OTA 服務未啟動";
              document.getElementById("otaUploadArea").style.display = "none";
            }
          })
          .catch((error) => {
            console.error("檢查 OTA 狀態失敗:", error);
          });
      }

      function uploadFirmware() {
        if (!currentUploadFile || otaUploading) return;

        // 檢查檔案類型
        if (!currentUploadFile.name.endsWith(".bin")) {
          showToast("請選擇 .bin 格式的韌體檔案", "error");
          return;
        }

        // 警告確認
        if (
          !confirm(
            "⚠️ 警告！\n\n韌體更新期間：\n1. 請勿斷電或重啟設備\n2. 請勿關閉此頁面\n3. 整個過程可能需要數分鐘\n\n確定要開始更新嗎？",
          )
        ) {
          return;
        }

        otaUploading = true;
        const formData = new FormData();
        formData.append("firmware", currentUploadFile);

        const uploadBtn = document.getElementById("uploadBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const progress = document.getElementById("uploadProgress");
        const bar = document.getElementById("uploadBar");
        const percent = document.getElementById("uploadPercent");
        const details = document.getElementById("uploadDetails");

        uploadBtn.disabled = true;
        uploadBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> 上傳中...';
        cancelBtn.style.display = "inline-block";
        progress.style.display = "block";

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener("progress", (e) => {
          if (e.lengthComputable) {
            const percentage = Math.round((e.loaded / e.total) * 100);
            bar.style.width = percentage + "%";
            percent.textContent = percentage + "%";
            details.textContent = `${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`;
          }
        });

        xhr.addEventListener("load", () => {
          if (xhr.status === 200) {
            showOtaSuccessModal(currentUploadFile);
          } else {
            showToast("上傳失敗: " + xhr.statusText, "error");
          }
          resetUploadUI();
        });

        xhr.addEventListener("error", () => {
          showToast("上傳失敗，請檢查網路連接", "error");
          resetUploadUI();
        });

        xhr.addEventListener("abort", () => {
          showToast("上傳已取消", "warning");
          resetUploadUI();
        });

        xhr.open("POST", "/api/ota/upload");
        xhr.send(formData);

        // 取消上傳函數
        window.cancelUpload = function () {
          if (confirm("確定要取消上傳嗎？")) {
            xhr.abort();
          }
        };

        function resetUploadUI() {
          otaUploading = false;
          currentUploadFile = null;
          document.getElementById("otaFile").value = "";
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 開始上傳';
          cancelBtn.style.display = "none";
          progress.style.display = "none";
          bar.style.width = "0%";
          percent.textContent = "0%";
          details.textContent = "0 KB / 0 KB";
        }
      }

      function showOtaSuccessModal(file) {
        const modal = document.getElementById("otaSuccessModal");
        document.getElementById("otaFileName").textContent = file.name;
        document.getElementById("otaFileSize").textContent = formatFileSize(
          file.size,
        );
        document.getElementById("otaUpdateTime").textContent =
          new Date().toLocaleString();

        modal.classList.add("show");
        document.body.style.overflow = "hidden";

        // 開始倒數計時
        otaCountdownValue = 30;
        const countdownElement = document.getElementById("otaCountdown");

        otaCountdownTimer = setInterval(() => {
          otaCountdownValue--;
          countdownElement.textContent = otaCountdownValue;

          if (otaCountdownValue <= 0) {
            clearInterval(otaCountdownTimer);
            rebootDevice();
          }
        }, 1000);
      }

      function closeOtaModal() {
        const modal = document.getElementById("otaSuccessModal");
        modal.classList.remove("show");
        document.body.style.overflow = "auto";

        if (otaCountdownTimer) {
          clearInterval(otaCountdownTimer);
          otaCountdownTimer = null;
        }
      }

      function copyHostname() {
        const hostname = document.getElementById("otaHostname").textContent;
        navigator.clipboard
          .writeText(hostname)
          .then(() => {
            showToast("主機名已複製到剪貼簿", "success");
          })
          .catch((err) => {
            showToast("複製失敗", "error");
          });
      }

      // 輔助函數：格式化檔案大小
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // ============ 彈跳視窗相關函數 ============
      function showConnectionModal(data) {
        currentConnectionData = data;
        currentWiFiIP = data.ip;
        currentWiFiSSID = data.ssid;

        // 更新彈跳視窗內容
        document.getElementById("modalMessage").textContent =
          data.formatted_message || "WiFi連接成功！";
        document.getElementById("modalIP").textContent = data.ip;
        // document.getElementById('modalSSID').textContent = data.ssid;
        // document.getElementById('modalGateway').textContent = data.gateway || '192.168.1.1';
        // document.getElementById('modalRSSI').textContent = (data.rssi || '-') + ' dBm';

        // 顯示彈跳視窗
        const modal = document.getElementById("connectionModal");
        modal.classList.add("show");

        // 阻止背景滾動
        document.body.style.overflow = "hidden";

        // 3秒後自動關閉提示（可選）
        setTimeout(() => {
          if (modal.classList.contains("show")) {
            closeModal();
          }
        }, 10000);
      }

      function closeModal() {
        const modal = document.getElementById("connectionModal");
        modal.classList.remove("show");

        // 恢復背景滾動
        document.body.style.overflow = "auto";

        // 更新連線狀態卡片
        if (currentWiFiSSID && currentWiFiIP) {
          updateConnectionCard();
        }

        // 更新網路狀態
        updateNetworkStatus();
      }

      function copyIP() {
        const ip = document.getElementById("modalIP").textContent;
        navigator.clipboard
          .writeText(ip)
          .then(() => {
            const btn = document.querySelector(".ip-copy-btn");
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> 已複製！';
            btn.classList.add("copied");

            // 顯示提示
            showToast("IP地址已複製到剪貼簿", "success");

            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove("copied");
            }, 2000);
          })
          .catch((err) => {
            console.error("複製失敗:", err);
            showToast("複製失敗", "error");
          });
      }

      function openDeviceWeb() {
        const ip = document.getElementById("modalIP").textContent;
        if (ip && ip !== "Loading...") {
          window.open(`http://${ip}`, "_blank");
        } else {
          showToast("無法獲取IP地址", "error");
        }
      }

      // 點擊彈跳視窗外部關閉
      document
        .getElementById("connectionModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

      // ESC鍵關閉彈跳視窗
      document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("connectionModal");
        if (e.key === "Escape" && modal.classList.contains("show")) {
          closeModal();
        }
      });

      // ============ 其他功能函數 ============
      // 切換標籤頁
      function switchTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.getElementById(tabName).classList.add("active");
      }

      // 切換到WiFi頁面並自動掃描
      function switchToWiFiAndScan() {
        switchTab("wifi");
        setTimeout(scanWifi, 500);
      }

      // 顯示Toast訊息
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const icon = toast.querySelector(".toast-icon");
        const messageDiv = toast.querySelector(".toast-message");

        toast.className = "toast";
        toast.classList.add(`toast-${type}`);
        toast.classList.add("show");

        icon.innerHTML =
          type === "success"
            ? '<i class="fas fa-check-circle" style="color: #28a745; font-size: 1.5rem; margin-right: 15px;"></i>'
            : '<i class="fas fa-exclamation-circle" style="color: #dc3545; font-size: 1.5rem; margin-right: 15px;"></i>';

        messageDiv.textContent = message;

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // 更新網路狀態
      async function updateNetworkStatus() {
        try {
          const response = await fetch("/api/network/status");
          const data = await response.json();

          if (data.wifi_task_core) {
            document.getElementById("wifiThreadStatus").textContent =
              `運行中 (${data.wifi_task_core})`;
          }
          if (data.eth_task_core) {
            document.getElementById("ethThreadStatus").textContent =
              `運行中 (${data.eth_task_core})`;
          }

          // 更新WiFi狀態
          const wifiStatus = document.getElementById("wifiStatus");
          const wifiInfo = document.getElementById("wifiInfo");

          if (data.wifi_connected) {
            wifiStatus.className = "status-indicator status-online";
            wifiInfo.innerHTML = `<strong>${data.wifi_ssid}</strong><br>IP: ${data.wifi_ip}<br>訊號: ${data.wifi_rssi || "-"} dBm`;

            // 更新連線狀態卡片
            currentWiFiSSID = data.wifi_ssid;
            currentWiFiIP = data.wifi_ip;
            updateConnectionCard();
          } else {
            wifiStatus.className = "status-indicator status-offline";
            wifiInfo.textContent = "未連接";
            // 隱藏連線狀態卡片
            hideConnectionCard();
          }

          // 更新乙太網路狀態
          const ethStatus = document.getElementById("ethStatus");
          const ethInfo = document.getElementById("ethInfo");

          if (data.eth_connected) {
            ethStatus.className = "status-indicator status-online";
            ethInfo.innerHTML = `<strong>已連接</strong><br>IP: ${data.eth_ip}<br>閘道器: ${data.eth_gateway}`;
          } else {
            ethStatus.className = "status-indicator status-offline";
            ethInfo.textContent = "未連接";
          }

          // 更新模式
          const currentMode = document.getElementById("currentMode");
          const modeText = ["AP模式", "WiFi模式", "乙太網路模式", "雙網路模式"][
            data.current_mode
          ];
          currentMode.textContent = modeText;

          // 更新系統資訊
          const systemInfo = document.getElementById("systemInfo");
          let info = `目前模式: ${modeText}<br>`;

          if (data.ap_ip) {
            info += `AP IP: ${data.ap_ip}<br>`;
          }
          if (data.current_ip) {
            info += `訪問地址: http://${data.current_ip}`;
          }

          systemInfo.innerHTML = info;
        } catch (error) {
          console.error("更新狀態失敗:", error);
        }
      }

      // 更新連線狀態卡片
      function updateConnectionCard() {
        if (currentWiFiSSID && currentWiFiIP) {
          const card = document.getElementById("wifiConnectionCard");
          const connectedSSID = document.getElementById("connectedSSID");
          const connectedIP = document.getElementById("connectedIP");

          if (card && connectedSSID && connectedIP) {
            connectedSSID.textContent = currentWiFiSSID;
            connectedIP.textContent = currentWiFiIP;

            card.style.display = "block";

            // 添加動畫效果
            card.style.animation = "fadeIn 0.5s";
          }
        }
      }

      // 隱藏連線狀態卡片
      function hideConnectionCard() {
        const card = document.getElementById("wifiConnectionCard");
        if (card) {
          card.style.display = "none";
          currentWiFiSSID = "";
          currentWiFiIP = "";
        }
      }

      // 掃描WiFi
      async function scanWifi() {
        if (isScanning) {
          showToast("正在掃描中，請稍候...", "error");
          return;
        }

        isScanning = true;
        const scanBtn = document.getElementById("scanBtn");
        const scanStatus = document.getElementById("scanStatus");

        try {
          scanBtn.disabled = true;
          scanBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> 掃描中...';
          scanStatus.textContent = "掃描中，請稍候...";
          showToast("開始掃描WiFi網路...", "success");

          const response = await fetch("/api/scan");
          const networks = await response.json();

          const container = document.getElementById("wifiList");

          if (networks.length === 0) {
            container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #666;">
                            <i class="fas fa-wifi-slash" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            未發現WiFi網路
                        </div>
                    `;
            scanStatus.textContent = "掃描完成，未發現網路";
            showToast("未發現WiFi網路", "error");
          } else {
            let html = "";
            networks.forEach((network) => {
              // 創建訊號強度條
              let signalBars = '<div class="signal-bars">';
              for (let i = 0; i < 4; i++) {
                signalBars += `<div class="signal-bar ${i < network.signal_level ? "active" : ""}"></div>`;
              }
              signalBars += "</div>";

              html += `
                            <div class="wifi-item" onclick="selectWifi(this, '${network.ssid.replace(/'/g, "\\'")}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${network.ssid || "隱藏網路"}</strong><br>
                                        <small style="color: #666;">
                                            訊號: ${network.rssi} dBm | 
                                            通道: ${network.channel} | 
                                            加密: ${network.encryption_name}
                                        </small>
                                    </div>
                                    ${signalBars}
                                </div>
                            </div>
                        `;
            });

            container.innerHTML = html;
            scanStatus.textContent = `掃描完成，發現 ${networks.length} 個網路`;
            showToast(`發現 ${networks.length} 個網路`, "success");
          }
        } catch (error) {
          console.error("掃描失敗:", error);
          scanStatus.textContent = "掃描失敗";
          showToast("掃描失敗", "error");
        } finally {
          isScanning = false;
          scanBtn.disabled = false;
          scanBtn.innerHTML = '<i class="fas fa-search"></i> 掃描 WiFi 網路';
        }
      }

      // 選擇WiFi
      function selectWifi(element, ssid) {
        document.querySelectorAll(".wifi-item").forEach((item) => {
          item.classList.remove("selected");
        });
        element.classList.add("selected");
        selectedWifi = ssid;
        document.getElementById("wifiSsid").value = ssid;

        // 自動將焦點移到密碼欄位
        document.getElementById("wifiPassword").focus();

        showToast(`已選擇網路: ${ssid}`, "success");
      }

      // 連接WiFi
      async function connectWifi() {
        let ssid = document.getElementById("wifiSsid").value;
        const password = document.getElementById("wifiPassword").value;

        if (!ssid && selectedWifi) {
          ssid = selectedWifi;
        }

        if (!ssid) {
          showToast("請輸入或選擇WiFi名稱", "error");
          return;
        }

        const connectBtn = document.getElementById("connectBtn");

        try {
          connectBtn.disabled = true;
          connectBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> 連接中...';
          showToast("正在連接WiFi...", "success");

          const response = await fetch("/api/connect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ssid, password }),
          });

          const result = await response.json();

          if (result.success) {
            // 顯示彈跳視窗
            showConnectionModal(result);

            // 清空密碼欄位
            document.getElementById("wifiPassword").value = "";
          } else {
            showToast(result.message || "連接失敗", "error");
          }
        } catch (error) {
          console.error("連接失敗:", error);
          showToast("連接失敗", "error");
        } finally {
          connectBtn.disabled = false;
          connectBtn.innerHTML = '<i class="fas fa-plug"></i> 連接到 WiFi';
        }
      }

      // 選擇模式
      function selectMode(mode) {
        selectedMode = mode;
        document.querySelectorAll(".mode-option").forEach((opt) => {
          opt.classList.remove("active");
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add("active");
      }

      // 儲存網路模式
      async function saveNetworkMode() {
        try {
          const response = await fetch("/api/mode", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mode: selectedMode }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("模式已設置，請重新啟動生效", "success");

            if (confirm("是否立即重新啟動？")) {
              rebootDevice();
            }
          } else {
            showToast(result.message, "error");
          }
        } catch (error) {
          console.error("設置模式失敗:", error);
          showToast("設置失敗", "error");
        }
      }

      // 儲存乙太網路設定
      async function saveEthConfig() {
        const config = {
          dhcp: document.getElementById("ethDhcp").checked,
          ip: document.getElementById("ethIp").value,
          gateway: document.getElementById("ethGateway").value,
          subnet: document.getElementById("ethSubnet").value,
          dns1: document.getElementById("ethDns1").value,
          dns2: document.getElementById("ethDns2").value,
        };

        if (!config.dhcp) {
          if (!config.ip || !config.gateway || !config.subnet) {
            showToast("請填寫所有靜態IP欄位", "error");
            return;
          }

          // DNS 非必填，但提供預設值
          if (!config.dns1) config.dns1 = "8.8.8.8";
          if (!config.dns2) config.dns2 = "8.8.4.4";
        }

        try {
          const response = await fetch("/api/eth/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(config),
          });

          const result = await response.json();
          showToast(result.message, result.success ? "success" : "error");

          if (result.success) {
            updateNetworkStatus();
          }
        } catch (error) {
          console.error("保存失敗:", error);
          showToast("保存失敗", "error");
        }
      }

      // 載入配置
      async function loadConfig() {
        try {
          const response = await fetch("/api/config/load");
          currentConfig = await response.json();

          // 填充表單
          document.getElementById("wifiSsid").value =
            currentConfig.wifi_ssid || "";
          document.getElementById("ethDhcp").checked = currentConfig.eth_dhcp;
          document.getElementById("ethIp").value = currentConfig.eth_ip || "";
          document.getElementById("ethGateway").value =
            currentConfig.eth_gateway || "";
          document.getElementById("ethSubnet").value =
            currentConfig.eth_subnet || "";
          document.getElementById("ethDns1").value =
            currentConfig.eth_dns1 || "8.8.8.8";
          document.getElementById("ethDns2").value =
            currentConfig.eth_dns2 || "8.8.4.4";

          // 更新模式選擇
          selectMode(currentConfig.mode);

          // 更新靜態配置顯示
          document.getElementById("staticConfig").style.display =
            currentConfig.eth_dhcp ? "none" : "block";

          showToast("配置已載入", "success");
        } catch (error) {
          console.error("載入配置失敗:", error);
          showToast("載入配置失敗", "error");
        }
      }

      // 儲存所有配置
      async function saveAllConfig() {
        try {
          const response = await fetch("/api/config/save", {
            method: "POST",
          });

          const result = await response.json();
          showToast(result.message, "success");
        } catch (error) {
          console.error("保存失敗:", error);
          showToast("保存失敗", "error");
        }
      }

      // 重新啟動設備
      async function rebootDevice() {
        if (confirm("確定要重新啟動系統嗎？")) {
          try {
            await fetch("/api/reboot", { method: "POST" });
            showToast("系統將在3秒後重新啟動", "success");

            setTimeout(() => {
              showToast("請稍後刷新頁面", "success");
            }, 3000);
          } catch (error) {
            console.error("重啟失敗:", error);
          }
        }
      }

      // 重置配置
      function resetConfig() {
        if (confirm("確定要重置所有設定為預設值嗎？")) {
          document.getElementById("wifiSsid").value = "";
          document.getElementById("wifiPassword").value = "";
          document.getElementById("ethDhcp").checked = true;
          document.getElementById("ethIp").value = "192.168.1.100";
          document.getElementById("ethGateway").value = "192.168.1.1";
          document.getElementById("ethSubnet").value = "255.255.255.0";
          document.getElementById("staticConfig").style.display = "none";
          document.getElementById("ethDns1").value = "8.8.8.8";
          document.getElementById("ethDns2").value = "8.8.4.4";
          selectMode(0);
          hideConnectionCard();

          showToast("配置已重置為預設值", "success");
        }
      }
    </script>
  </body>
</html>
